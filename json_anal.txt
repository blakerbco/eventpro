<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JSON Field Analyzer</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
:root {
  --bg: #090B0E;
  --bg2: #101318;
  --bg3: #171B22;
  --bg4: #1E232C;
  --bg5: #262C36;
  --surface: #13161D;
  --border: #252A35;
  --border2: #303844;
  --text: #E6EAF0;
  --text2: #8E96A6;
  --text3: #545C6C;
  --cyan: #22D3EE;
  --cyan-dim: #0C2A30;
  --cyan-glow: rgba(34,211,238,0.08);
  --orange: #FB923C;
  --orange-dim: #2E1E0C;
  --red: #F87171;
  --red-dim: #2E1010;
  --green: #4ADE80;
  --green-dim: #0E2818;
  --violet: #A78BFA;
  --violet-dim: #1A1430;
  --amber: #FBBF24;
  --amber-dim: #2A2008;
  --radius: 10px;
  --radius-lg: 14px;
  --shadow: 0 2px 10px rgba(0,0,0,0.35);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
}

html:not(.dark) {
  --bg: #F7F5F2;
  --bg2: #EFECE8;
  --bg3: #E6E2DC;
  --bg4: #DDD8D0;
  --bg5: #D4CEC4;
  --surface: #FFFFFF;
  --border: #D6D0C8;
  --border2: #C4BEB4;
  --text: #18160E;
  --text2: #68625A;
  --text3: #9A9488;
  --cyan: #0891B2;
  --cyan-dim: #E0F7FA;
  --cyan-glow: rgba(8,145,178,0.05);
  --orange: #EA580C;
  --orange-dim: #FFF3E0;
  --red: #DC2626;
  --red-dim: #FFEBEE;
  --green: #16A34A;
  --green-dim: #E8F5E9;
  --violet: #7C3AED;
  --violet-dim: #EDE7F6;
  --amber: #D97706;
  --amber-dim: #FFF8E1;
  --shadow: 0 2px 10px rgba(0,0,0,0.06);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Instrument Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  line-height: 1.55;
  -webkit-font-smoothing: antialiased;
}

.app { max-width: 960px; margin: 0 auto; padding: 24px 14px 80px; }

header { text-align: center; margin-bottom: 28px; animation: fadeIn .5s ease; }

@keyframes fadeIn { from { opacity:0; transform:translateY(-10px) } to { opacity:1; transform:translateY(0) } }
@keyframes slideUp { from { opacity:0; transform:translateY(16px) } to { opacity:1; transform:translateY(0) } }
@keyframes pop { from { opacity:0; transform:scale(.96) } to { opacity:1; transform:scale(1) } }
@keyframes barGrow { from { width:0 } }

header h1 { font-size: clamp(1.4rem, 4.5vw, 2rem); font-weight: 700; letter-spacing: -.03em; }
header h1 .hl { color: var(--cyan); }
header p { color: var(--text2); font-size: .92rem; margin-top: 4px; font-weight: 400; }

/* DROPZONE */
.dropzone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-lg);
  padding: 42px 24px;
  text-align: center;
  cursor: pointer;
  transition: all .25s;
  background: var(--surface);
  position: relative;
  animation: slideUp .45s ease .08s both;
}
.dropzone:hover, .dropzone.over { border-color: var(--cyan); background: var(--cyan-glow); }
.dropzone.over { transform: scale(1.005); }
.dz-icon { width:50px; height:50px; margin:0 auto 12px; background:var(--bg3); border-radius:13px; display:flex; align-items:center; justify-content:center; font-size:20px; color:var(--cyan); transition:background .25s; }
.dropzone:hover .dz-icon { background: var(--cyan-dim); }
.dropzone h3 { font-weight: 600; font-size: 1rem; }
.dropzone .sub { color: var(--text3); font-size: .82rem; margin-top: 3px; }
.dropzone .cap { display:inline-block; margin-top:10px; font-family:'IBM Plex Mono',monospace; font-size:.7rem; color:var(--text3); background:var(--bg3); padding:3px 10px; border-radius:6px; }
.dropzone input { position:absolute; inset:0; opacity:0; cursor:pointer; }

/* FILE TABS */
.file-tabs { display:flex; gap:6px; margin:16px 0 14px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin; scrollbar-color:var(--border) transparent; animation:slideUp .4s ease both; }
.file-tab { display:flex; align-items:center; gap:6px; padding:7px 12px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text2); font-family:'IBM Plex Mono',monospace; font-size:.74rem; cursor:pointer; white-space:nowrap; transition:all .2s; flex-shrink:0; }
.file-tab:hover { border-color:var(--cyan); color:var(--text); }
.file-tab.active { background:var(--cyan); color:#000; border-color:var(--cyan); }
.file-tab .xtab { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%; font-size:11px; transition:background .15s; cursor:pointer; }
.file-tab .xtab:hover { background:rgba(255,255,255,.2); }
.file-tab:not(.active) .xtab:hover { background:var(--red-dim); color:var(--red); }

/* SECTIONS */
.section { margin-bottom: 18px; animation: slideUp .4s ease both; }
.section-title { font-family:'IBM Plex Mono',monospace; font-size:.72rem; text-transform:uppercase; letter-spacing:.07em; color:var(--text3); font-weight:600; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.section-title i { color:var(--cyan); font-size:11px; }
.section-title .stcount { color:var(--text2); font-weight:400; }

/* STAT CARDS */
.stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; }
.stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:14px 16px; box-shadow:var(--shadow); }
.stat-card .sc-label { font-size:.68rem; text-transform:uppercase; letter-spacing:.06em; color:var(--text3); font-family:'IBM Plex Mono',monospace; font-weight:500; }
.stat-card .sc-val { font-size:1.6rem; font-weight:700; font-family:'IBM Plex Mono',monospace; margin-top:2px; }
.stat-card.sc-total .sc-val { color:var(--text); }
.stat-card.sc-fields .sc-val { color:var(--cyan); }
.stat-card.sc-combos .sc-val { color:var(--violet); }
.stat-card.sc-errors .sc-val { color:var(--red); }

/* FIELD TABLE */
.ftable-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow); overflow:hidden; }
.ftable-header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:var(--bg2); flex-wrap:wrap; gap:6px; }
.ftable-header span { font-family:'IBM Plex Mono',monospace; font-size:.76rem; color:var(--text3); }
.sort-btns { display:flex; gap:3px; }
.sort-btn { padding:4px 10px; border:1px solid var(--border); border-radius:6px; background:var(--bg3); color:var(--text3); font-family:'Instrument Sans',sans-serif; font-size:.76rem; font-weight:500; cursor:pointer; transition:all .2s; }
.sort-btn:hover { color:var(--text2); border-color:var(--border2); }
.sort-btn.active { background:var(--cyan); color:#000; border-color:var(--cyan); }

.ftable-body { max-height:55vh; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.frow { display:grid; grid-template-columns:minmax(140px,1.2fr) 80px 80px 1fr; align-items:center; gap:10px; padding:10px 16px; border-bottom:1px solid var(--border); transition:background .12s; }
.frow:last-child { border-bottom:none; }
.frow:hover { background:var(--bg2); }
.frow-name { font-family:'IBM Plex Mono',monospace; font-size:.8rem; font-weight:500; color:var(--text); word-break:break-all; }
.frow-pop { font-family:'IBM Plex Mono',monospace; font-size:.78rem; color:var(--green); font-weight:600; }
.frow-miss { font-family:'IBM Plex Mono',monospace; font-size:.78rem; color:var(--orange); font-weight:600; }
.frow-bar { height:8px; border-radius:4px; background:var(--bg4); overflow:hidden; position:relative; }
.frow-bar-fill { height:100%; border-radius:4px; animation:barGrow .6s ease both; }
.frow-bar-fill.full { background:var(--green); }
.frow-bar-fill.high { background:var(--cyan); }
.frow-bar-fill.mid { background:var(--amber); }
.frow-bar-fill.low { background:var(--orange); }
.frow-bar-fill.crit { background:var(--red); }

.frow-head { background:var(--bg3); font-size:.66rem; text-transform:uppercase; letter-spacing:.06em; color:var(--text3); font-weight:600; font-family:'IBM Plex Mono',monospace; padding:8px 16px; position:sticky; top:0; z-index:2; border-bottom:1px solid var(--border); }

/* COMBO TABLE */
.combo-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow); overflow:hidden; }
.combo-header { padding:12px 16px; border-bottom:1px solid var(--border); background:var(--bg2); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:6px; }
.combo-header span { font-family:'IBM Plex Mono',monospace; font-size:.76rem; color:var(--text3); }
.combo-body { max-height:50vh; overflow-y:auto; scrollbar-width:thin; scrollbar-color:var(--border) transparent; }
.combo-row { display:grid; grid-template-columns:1fr 70px 80px; gap:10px; align-items:center; padding:10px 16px; border-bottom:1px solid var(--border); transition:background .12s; }
.combo-row:last-child { border-bottom:none; }
.combo-row:hover { background:var(--bg2); }
.combo-row-head { background:var(--bg3); font-size:.66rem; text-transform:uppercase; letter-spacing:.06em; color:var(--text3); font-weight:600; font-family:'IBM Plex Mono',monospace; padding:8px 16px; position:sticky; top:0; z-index:2; border-bottom:1px solid var(--border); }
.combo-fields { display:flex; flex-wrap:wrap; gap:4px; }
.combo-tag { font-family:'IBM Plex Mono',monospace; font-size:.7rem; padding:2px 7px; border-radius:5px; background:var(--orange-dim); color:var(--orange); white-space:nowrap; }
.combo-tag.full { background:var(--green-dim); color:var(--green); }
.combo-count { font-family:'IBM Plex Mono',monospace; font-size:.82rem; font-weight:600; color:var(--text); text-align:right; }
.combo-pct { font-family:'IBM Plex Mono',monospace; font-size:.74rem; color:var(--text3); text-align:right; }

/* EXPORT */
.export-row { display:flex; gap:8px; margin-top:16px; flex-wrap:wrap; animation:slideUp .4s ease both; }
.ebtn { padding:8px 16px; border:1px solid var(--border); border-radius:8px; background:var(--bg3); color:var(--text2); font-family:'Instrument Sans',sans-serif; font-size:.85rem; font-weight:500; cursor:pointer; transition:all .2s; text-decoration:none; display:inline-flex; align-items:center; gap:6px; }
.ebtn:hover { border-color:var(--cyan); color:var(--cyan); }
.ebtn.primary { background:var(--cyan); border-color:var(--cyan); color:#000; }
.ebtn.primary:hover { filter:brightness(1.1); }

.empty-state { text-align:center; padding:40px 24px; color:var(--text3); }
.hidden { display:none !important; }

@media(max-width:600px) {
  .stats-row { grid-template-columns:repeat(2,1fr); }
  .frow { grid-template-columns:minmax(100px,1fr) 60px 60px 80px; gap:6px; padding:8px 12px; font-size:.75rem; }
  .combo-row { grid-template-columns:1fr 50px 60px; gap:6px; padding:8px 12px; }
  .export-row { flex-direction:column; }
  .ebtn { justify-content:center; }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1><i class="fas fa-microscope" style="color:var(--cyan);font-size:.85em"></i> JSON Field <span class="hl">Analyzer</span></h1>
    <p>Analyze field completeness across all records</p>
  </header>

  <div class="dropzone" id="dropzone">
    <div class="dz-icon"><i class="fas fa-file-code"></i></div>
    <h3>Drop JSON files here</h3>
    <p class="sub">or click to browse — up to 5 MB per file</p>
    <span class="cap">accepts .json arrays or objects</span>
    <input type="file" id="fileInput" accept=".json" multiple>
  </div>

  <div id="dashboard" class="hidden">
    <div class="file-tabs" id="fileTabs"></div>

    <div class="section">
      <div class="section-title"><i class="fas fa-chart-bar"></i> Overview</div>
      <div class="stats-row">
        <div class="stat-card sc-total"><div class="sc-label">Records</div><div class="sc-val" id="stRecords">0</div></div>
        <div class="stat-card sc-fields"><div class="sc-label">Unique Fields</div><div class="sc-val" id="stFields">0</div></div>
        <div class="stat-card sc-combos"><div class="sc-label">Missing Combos</div><div class="sc-val" id="stCombos">0</div></div>
        <div class="stat-card sc-errors"><div class="sc-label">Discarded Errors</div><div class="sc-val" id="stErrors">0</div></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><i class="fas fa-th-list"></i> Field Completeness <span class="stcount" id="fieldCountLabel"></span></div>
      <div class="ftable-wrap">
        <div class="ftable-header">
          <span>Populated vs Missing per field</span>
          <div class="sort-btns">
            <button class="sort-btn active" data-sort="name">A–Z</button>
            <button class="sort-btn" data-sort="pop-desc">Most filled</button>
            <button class="sort-btn" data-sort="miss-desc">Most empty</button>
          </div>
        </div>
        <div class="ftable-body" id="ftableBody"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title"><i class="fas fa-puzzle-piece"></i> Missing Field Combinations <span class="stcount" id="comboCountLabel"></span></div>
      <div class="combo-wrap">
        <div class="combo-header">
          <span>Records grouped by which fields are empty</span>
        </div>
        <div class="combo-body" id="comboBody"></div>
      </div>
    </div>

    <div class="export-row">
      <button class="ebtn" id="exportJsonBtn"><i class="fas fa-code"></i> Export Report JSON</button>
      <button class="ebtn" id="exportCsvBtn"><i class="fas fa-table"></i> Export Report CSV</button>
      <button class="ebtn primary" id="exportCompleteBtn"><i class="fas fa-download"></i> Download Complete Records</button>
    </div>
  </div>
</div>

<script>
(function(){
  "use strict";

  /* Dark mode */
  if(window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches){ document.documentElement.classList.add("dark"); }
  window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function(e){
    if(e.matches){ document.documentElement.classList.add("dark"); } else { document.documentElement.classList.remove("dark"); }
  });

  var MAX_SIZE = 5 * 1024 * 1024;
  var files = {};
  var activeFile = null;
  var currentSort = "name";

  var dropzone = document.getElementById("dropzone");
  var fileInput = document.getElementById("fileInput");
  var dashboard = document.getElementById("dashboard");
  var fileTabs = document.getElementById("fileTabs");

  /* Drag & Drop */
  dropzone.addEventListener("dragover", function(e){ e.preventDefault(); dropzone.classList.add("over"); });
  dropzone.addEventListener("dragleave", function(){ dropzone.classList.remove("over"); });
  dropzone.addEventListener("drop", function(e){ e.preventDefault(); dropzone.classList.remove("over"); handleFiles(e.dataTransfer.files); });
  fileInput.addEventListener("change", function(e){ handleFiles(e.target.files); e.target.value=""; });

  function handleFiles(fl){
    for(var i=0; i<fl.length; i++){
      var f = fl[i];
      if(!f.name.endsWith(".json")){ showToast(f.name + " is not a .json file"); continue; }
      if(f.size > MAX_SIZE){ showToast(f.name + " exceeds 5 MB limit"); continue; }
      (function(file){
        var reader = new FileReader();
        reader.onload = function(ev){
          try {
            var raw = JSON.parse(ev.target.result);
            var arr = normalizeToArray(raw);
            if(arr.length === 0){ showToast(file.name + ": no records found"); return; }
            processFile(file.name, arr);
          } catch(err){
            showToast("Failed to parse " + file.name);
          }
        };
        reader.readAsText(file);
      })(f);
    }
  }

  function normalizeToArray(data){
    if(Array.isArray(data)) return flattenObjects(data);
    if(data && typeof data === "object"){
      var vals = Object.values(data);
      return flattenObjects(vals);
    }
    return [];
  }

  function flattenObjects(arr){
    var out = [];
    for(var i=0; i<arr.length; i++){
      if(Array.isArray(arr[i])){
        for(var j=0; j<arr[i].length; j++){
          if(arr[i][j] && typeof arr[i][j] === "object" && !Array.isArray(arr[i][j])) out.push(arr[i][j]);
        }
      } else if(arr[i] && typeof arr[i] === "object"){
        out.push(arr[i]);
      }
    }
    return out;
  }

  function isEmpty(val){
    if(val === undefined || val === null) return true;
    if(typeof val === "number") return false;
    if(typeof val === "boolean") return false;
    if(typeof val === "string" && val.trim() === "") return true;
    return false;
  }

  var ERROR_MARKER = "Error during research: poe.BotError:";

  function isErrorRecord(rec){
    if(!rec || !rec.event_summary) return false;
    return String(rec.event_summary).indexOf(ERROR_MARKER) !== -1;
  }

  /* Analysis */
  function analyze(records){
    var allFields = {};
    var i, j, key;

    // 1: Collect all unique field names
    for(i=0; i<records.length; i++){
      var keys = Object.keys(records[i]);
      for(j=0; j<keys.length; j++){
        allFields[keys[j]] = true;
      }
    }
    var fieldNames = Object.keys(allFields).sort();

    // 2: Per-field stats
    var fieldStats = [];
    for(i=0; i<fieldNames.length; i++){
      key = fieldNames[i];
      var populated = 0;
      var missing = 0;
      for(j=0; j<records.length; j++){
        if(isEmpty(records[j][key])) missing++;
        else populated++;
      }
      fieldStats.push({ name:key, populated:populated, missing:missing });
    }

    // 3: Missing field combinations
    var combos = {};
    for(i=0; i<records.length; i++){
      var missingKeys = [];
      for(j=0; j<fieldNames.length; j++){
        if(isEmpty(records[i][fieldNames[j]])) missingKeys.push(fieldNames[j]);
      }
      var comboKey = missingKeys.length === 0 ? "__ALL_COMPLETE__" : missingKeys.join(" + ");
      if(!combos[comboKey]) combos[comboKey] = { fields:missingKeys, count:0 };
      combos[comboKey].count++;
    }

    var comboList = [];
    for(key in combos){
      comboList.push(combos[key]);
    }
    comboList.sort(function(a,b){ return b.count - a.count; });

    return {
      totalRecords: records.length,
      fieldNames: fieldNames,
      fieldStats: fieldStats,
      combos: comboList
    };
  }

  function processFile(name, records){
    var filtered = [];
    var errorCount = 0;
    for(var i=0; i<records.length; i++){
      if(isErrorRecord(records[i])){
        errorCount++;
      } else {
        filtered.push(records[i]);
      }
    }
    if(errorCount > 0){
      showToast("Discarded " + errorCount + " BotError record" + (errorCount !== 1 ? "s" : "") + " from " + name);
    }
    if(filtered.length === 0){ showToast(name + ": no valid records after filtering"); return; }
    var result = analyze(filtered);
    result.records = filtered;
    result.discardedErrors = errorCount;
    files[name] = result;
    activeFile = name;
    dashboard.classList.remove("hidden");
    renderTabs();
    renderDashboard();
  }

  /* Tabs */
  function renderTabs(){
    fileTabs.innerHTML = "";
    var names = Object.keys(files);
    for(var i=0; i<names.length; i++){
      (function(name){
        var tab = document.createElement("div");
        tab.className = "file-tab" + (name === activeFile ? " active" : "");
        var lbl = document.createElement("span");
        lbl.textContent = name;
        tab.appendChild(lbl);
        var x = document.createElement("span");
        x.className = "xtab";
        x.textContent = "×";
        x.addEventListener("click", function(e){ e.stopPropagation(); removeFile(name); });
        tab.appendChild(x);
        tab.addEventListener("click", function(){ activeFile=name; renderTabs(); renderDashboard(); });
        fileTabs.appendChild(tab);
      })(names[i]);
    }
  }

  function removeFile(name){
    delete files[name];
    var rem = Object.keys(files);
    if(rem.length===0){ activeFile=null; dashboard.classList.add("hidden"); return; }
    if(activeFile===name) activeFile=rem[0];
    renderTabs(); renderDashboard();
  }

  /* Dashboard */
  function renderDashboard(){
    var data = files[activeFile];
    if(!data) return;
    document.getElementById("stRecords").textContent = data.totalRecords;
    document.getElementById("stFields").textContent = data.fieldNames.length;
    var comboCount = data.combos.length;
    document.getElementById("stCombos").textContent = comboCount;
    document.getElementById("stErrors").textContent = data.discardedErrors || 0;
    document.getElementById("fieldCountLabel").textContent = "(" + data.fieldNames.length + " fields)";
    document.getElementById("comboCountLabel").textContent = "(" + comboCount + " patterns)";
    renderFieldTable();
    renderCombos();
  }

  /* Field Table */
  function renderFieldTable(){
    var data = files[activeFile];
    var stats = data.fieldStats.slice();
    var total = data.totalRecords;

    if(currentSort === "name") stats.sort(function(a,b){ return a.name.localeCompare(b.name); });
    else if(currentSort === "pop-desc") stats.sort(function(a,b){ return b.populated - a.populated || a.name.localeCompare(b.name); });
    else if(currentSort === "miss-desc") stats.sort(function(a,b){ return b.missing - a.missing || a.name.localeCompare(b.name); });

    var body = document.getElementById("ftableBody");
    body.innerHTML = "";

    var head = document.createElement("div");
    head.className = "frow-head frow";
    head.innerHTML = "<span>Field Name</span><span>Filled</span><span>Empty</span><span>Coverage</span>";
    body.appendChild(head);

    for(var i=0; i<stats.length; i++){
      var s = stats[i];
      var pct = total > 0 ? Math.round((s.populated / total) * 100) : 0;
      var row = document.createElement("div");
      row.className = "frow";

      var nameEl = document.createElement("div");
      nameEl.className = "frow-name";
      nameEl.textContent = s.name;
      row.appendChild(nameEl);

      var popEl = document.createElement("div");
      popEl.className = "frow-pop";
      popEl.textContent = s.populated;
      row.appendChild(popEl);

      var missEl = document.createElement("div");
      missEl.className = "frow-miss";
      missEl.textContent = s.missing;
      row.appendChild(missEl);

      var barWrap = document.createElement("div");
      barWrap.style.display = "flex";
      barWrap.style.alignItems = "center";
      barWrap.style.gap = "8px";

      var bar = document.createElement("div");
      bar.className = "frow-bar";
      bar.style.flex = "1";
      var fill = document.createElement("div");
      fill.className = "frow-bar-fill";
      fill.style.width = pct + "%";
      fill.style.animationDelay = (i * 0.03) + "s";
      if(pct === 100) fill.className += " full";
      else if(pct >= 80) fill.className += " high";
      else if(pct >= 50) fill.className += " mid";
      else if(pct >= 20) fill.className += " low";
      else fill.className += " crit";
      bar.appendChild(fill);
      barWrap.appendChild(bar);

      var pctEl = document.createElement("span");
      pctEl.style.cssText = "font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--text3);min-width:36px;text-align:right;";
      pctEl.textContent = pct + "%";
      barWrap.appendChild(pctEl);

      row.appendChild(barWrap);
      body.appendChild(row);
    }
  }

  /* Sort buttons */
  var sortBtns = document.querySelectorAll(".sort-btn");
  for(var si=0; si<sortBtns.length; si++){
    sortBtns[si].addEventListener("click", function(){
      for(var sj=0; sj<sortBtns.length; sj++) sortBtns[sj].classList.remove("active");
      this.classList.add("active");
      currentSort = this.getAttribute("data-sort");
      renderFieldTable();
    });
  }

  /* Combos */
  function renderCombos(){
    var data = files[activeFile];
    var total = data.totalRecords;
    var combos = data.combos;
    var body = document.getElementById("comboBody");
    body.innerHTML = "";

    var head = document.createElement("div");
    head.className = "combo-row-head combo-row";
    head.innerHTML = "<span>Missing Fields Pattern</span><span>Count</span><span>% of Total</span>";
    body.appendChild(head);

    for(var i=0; i<combos.length; i++){
      var c = combos[i];
      var pct = total > 0 ? ((c.count / total) * 100).toFixed(1) : "0.0";
      var row = document.createElement("div");
      row.className = "combo-row";

      var fieldsEl = document.createElement("div");
      fieldsEl.className = "combo-fields";
      if(c.fields.length === 0){
        var tag = document.createElement("span");
        tag.className = "combo-tag full";
        tag.textContent = "✓ All fields complete";
        fieldsEl.appendChild(tag);
      } else {
        for(var j=0; j<c.fields.length; j++){
          var tag2 = document.createElement("span");
          tag2.className = "combo-tag";
          tag2.textContent = c.fields[j];
          fieldsEl.appendChild(tag2);
        }
      }
      row.appendChild(fieldsEl);

      var countEl = document.createElement("div");
      countEl.className = "combo-count";
      countEl.textContent = c.count;
      row.appendChild(countEl);

      var pctEl = document.createElement("div");
      pctEl.className = "combo-pct";
      pctEl.textContent = pct + "%";
      row.appendChild(pctEl);

      body.appendChild(row);
    }
  }

  /* Exports */
  function downloadBlob(content, filename, mime){
    var blob = new Blob([content], {type:mime});
    var url = URL.createObjectURL(blob);
    var a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    document.body.removeChild(a); URL.revokeObjectURL(url);
  }

  document.getElementById("exportJsonBtn").addEventListener("click", function(){
    var data = files[activeFile];
    if(!data) return;
    var report = {
      file: activeFile,
      totalRecords: data.totalRecords,
      uniqueFields: data.fieldNames.length,
      fieldCompleteness: data.fieldStats.map(function(f){
        return { field:f.name, populated:f.populated, missing:f.missing, pct:data.totalRecords>0?Math.round(f.populated/data.totalRecords*100):0 };
      }),
      missingFieldCombinations: data.combos.map(function(c){
        return { missingFields:c.fields.length===0?["(none — all complete)"]:c.fields, count:c.count, pct:data.totalRecords>0?+((c.count/data.totalRecords)*100).toFixed(1):0 };
      })
    };
    downloadBlob(JSON.stringify(report,null,2), (activeFile||"report").replace(".json","")+"_analysis.json", "application/json");
  });

  document.getElementById("exportCsvBtn").addEventListener("click", function(){
    var data = files[activeFile];
    if(!data) return;
    var lines = ["Section,Field,Populated,Missing,Coverage %"];
    for(var i=0;i<data.fieldStats.length;i++){
      var f=data.fieldStats[i];
      var pct=data.totalRecords>0?Math.round(f.populated/data.totalRecords*100):0;
      lines.push("Field Completeness,"+escCSV(f.name)+","+f.populated+","+f.missing+","+pct);
    }
    lines.push("");
    lines.push("Section,Missing Fields,Count,% of Total");
    for(var j=0;j<data.combos.length;j++){
      var c=data.combos[j];
      var cpct=data.totalRecords>0?((c.count/data.totalRecords)*100).toFixed(1):"0.0";
      var label=c.fields.length===0?"(all complete)":c.fields.join(" + ");
      lines.push("Missing Combination,"+escCSV(label)+","+c.count+","+cpct);
    }
    downloadBlob(lines.join("\n"), (activeFile||"report").replace(".json","")+"_analysis.csv", "text/csv");
  });

  document.getElementById("exportCompleteBtn").addEventListener("click", function(){
    var data = files[activeFile];
    if(!data) return;
    var complete = [];
    for(var i=0; i<data.records.length; i++){
      var rec = data.records[i];
      var allFilled = true;
      for(var j=0; j<data.fieldNames.length; j++){
        if(isEmpty(rec[data.fieldNames[j]])){ allFilled=false; break; }
      }
      if(allFilled) complete.push(rec);
    }
    if(complete.length === 0){ showToast("No fully complete records found"); return; }
    downloadBlob(JSON.stringify(complete,null,2), (activeFile||"data").replace(".json","")+"_complete.json", "application/json");
    showToast("Downloaded " + complete.length + " complete records");
  });

  function escCSV(s){
    var v = String(s);
    if(v.indexOf('"')!==-1 || v.indexOf(",")!==-1 || v.indexOf("\n")!==-1 || v.indexOf("\r")!==-1){
      return '"' + v.replace(/"/g,'""') + '"';
    }
    return v;
  }

  /* Toast */
  function showToast(msg){
    var t = document.createElement("div");
    t.style.cssText = "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--bg5);color:var(--text);border:1px solid var(--border);padding:10px 22px;border-radius:10px;font-size:.88rem;z-index:200;animation:pop .25s ease;font-family:'Instrument Sans',sans-serif;box-shadow:var(--shadow-lg);max-width:90vw;text-align:center;";
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(function(){
      t.style.opacity = "0"; t.style.transition = "opacity .3s";
      setTimeout(function(){ if(t.parentNode) document.body.removeChild(t); }, 300);
    }, 2800);
  }
})();
</script>
</body>
</html>

